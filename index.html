<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ××©×™××•×ª ×¨××œ×™ ××˜×•"×¡</title>
    <style>
        :root { 
            --primary: #4f46e5; 
            --bg: #1e1b4b; 
            --accent: #10b981; 
            --edit: #f59e0b; 
            --danger: #ef4444; 
            --card-bg: rgba(255, 255, 255, 0.95);
        }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); 
            background-attachment: fixed;
            margin: 0; 
            padding: 20px; 
            direction: rtl; 
            text-align: right; 
            min-height: 100vh;
        }
        .card { 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: 20px; 
            max-width: 800px; 
            margin: auto; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); 
            backdrop-filter: blur(10px);
        }
        h2, h3, h4 { color: #1e1b4b; margin-top: 0; }
        input, button, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:hover { transform: translateY(-1px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); opacity: 0.95; }
        
        .class-box { border: 1px solid #e5e7eb; padding: 20px; border-radius: 15px; margin-top: 25px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .code-display { background: #fef3c7; color: #92400e; padding: 5px 12px; border-radius: 6px; font-family: monospace; font-weight: bold; border: 1px solid #fde68a; }
        
        .task-item { background: #f9fafb; border: 1px solid #eee; padding: 15px; margin: 12px 0; border-radius: 10px; position: relative; transition: 0.3s; }
        .task-item:hover { border-color: var(--primary); }
        .task-img-preview { max-width: 180px; display: block; margin-top: 10px; border-radius: 8px; cursor: pointer; border: 2px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .time-settings { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f3f4f6; padding: 12px; border-radius: 10px; margin-bottom: 15px; }
        .time-settings label { font-size: 12px; color: #4b5563; display: block; font-weight: 600; }
        
        .upload-area { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
        .file-label { cursor: pointer; background: #f3f4f6; padding: 10px; border-radius: 8px; font-size: 14px; white-space: nowrap; border: 1px dashed #cbd5e1; }
        .file-label:hover { background: #e2e8f0; }
        
        .hidden { display: none; }
        .edit-mode { background: #fffbeb; border: 1px dashed var(--edit); padding: 15px; border-radius: 10px; margin-top: 10px; }
        .btn-edit { background: var(--edit); width: auto; padding: 6px 12px; font-size: 13px; margin-left: 5px; }
        .edit-img-label { font-size: 12px; color: var(--primary); font-weight: 600; text-decoration: none; cursor: pointer; display: inline-block; margin-top: 8px; border-bottom: 1px dashed var(--primary); }
    </style>
</head>
<body>

<div class="card">
    <div id="loginArea">
        <h2>ğŸ‘‹ ×”×ª×—×‘×¨×•×ª ×œ××¢×¨×›×ª</h2>
        <input type="text" id="teacherUser" placeholder="×©× ××©×ª××©">
        <input type="password" id="teacherPass" placeholder="×¡×™×¡××”">
        <button id="loginBtn" onclick="login()">×”×ª×—×‘×¨×•×ª</button>
        <p id="authStatus" style="font-size: 12px; color: #666; text-align: center; margin-top: 10px;">××ª×—×‘×¨ ×œ×©×¨×ª...</p>
    </div>

    <div id="dashboard" style="display:none;">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <h3>×©×œ×•×, <span id="displayName"></span> ğŸ‘‹</h3>
            <button onclick="location.reload()" style="width:auto; padding:8px 15px; background:#ef4444;">×”×ª× ×ª×§</button>
        </div>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
        <h4>âœ¨ ×¦×•×¨ ×›×™×ª×” ×—×“×©×”:</h4>
        <div style="display:flex; gap:10px;">
            <input type="text" id="newClassName" placeholder="×œ××©×œ: ×›×™×ª×” ×˜'3 - ×‘×™×•×œ×•×’×™×”">
            <button onclick="createClass()" style="background:var(--accent); width:150px;">×¦×•×¨ ×›×™×ª×”</button>
        </div>
        
        <div id="classesList">×˜×•×¢×Ÿ ×›×™×ª×•×ª...</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "AIzaSyDvnS8L9r2LMKcUD78Ix7bldVp9qzbYwtk",
        authDomain: "tast-7808e.firebaseapp.com",
        projectId: "tast-7808e",
        storageBucket: "tast-7808e.firebasestorage.app",
        messagingSenderId: "99024860024",
        appId: "1:99024860024:web:24ab70c10254a2014fce8d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let teacherKey = "";
    let selectedImages = {}; 
    let editingImages = {}; 
    let currentUser = null;

    // MANDATORY RULE 3: Auth before queries
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (e) {
            console.error("Auth failed:", e);
            document.getElementById('authStatus').innerText = "×©×’×™××ª ×—×™×‘×•×¨. × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.";
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('authStatus').innerText = "××—×•×‘×¨ ×œ×©×¨×ª ×‘×”×¦×œ×—×” âœ…";
            console.log("Authenticated as:", user.uid);
        }
    });

    initAuth();

    // Helper for Rule 1: Strict Paths
    const getPublicCol = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);

    window.login = () => {
        if (!currentUser) return alert("×”××ª×Ÿ ×œ×—×™×‘×•×¨ ×¢× ×”×©×¨×ª...");
        const user = document.getElementById('teacherUser').value.trim();
        const pass = document.getElementById('teacherPass').value.trim();
        if(!user || !pass) return;
        teacherKey = user + "_" + pass;
        document.getElementById('displayName').innerText = user;
        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        loadClasses();
    };

    window.createClass = async () => {
        if (!currentUser) return;
        const name = document.getElementById('newClassName').value.trim();
        if(!name) return;
        const code = Math.random().toString(36).substring(2, 7).toUpperCase();
        try {
            await addDoc(getPublicCol("classes"), { 
                teacherId: teacherKey, 
                name, 
                code,
                createdAt: Date.now()
            });
            document.getElementById('newClassName').value = '';
        } catch (e) {
            handleError(e, "×™×¦×™×¨×ª ×›×™×ª×”");
        }
    };

    function handleError(e, action) {
        console.error(`Error in ${action}:`, e);
        if (e.code === 'permission-denied') {
            alert(`×©×’×™××ª ×”×¨×©××•×ª ×‘${action}. ×”××¢×¨×›×ª ×× ×¡×” ×œ×”×ª×—×‘×¨ ××—×“×©...`);
            initAuth();
        } else {
            alert(`×©×’×™××” ×‘${action}: ${e.message}`);
        }
    }

    window.handleImg = (e, code) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            selectedImages[code] = ev.target.result;
            document.getElementById(`label_${code}`).innerText = "âœ… ×ª××•× ×” × ×‘×—×¨×”";
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    window.handleEditImg = (e, taskId) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            editingImages[taskId] = ev.target.result;
            const prev = document.getElementById(`edit_preview_${taskId}`);
            if(prev) {
                if(prev.tagName === 'IMG') prev.src = ev.target.result;
                else {
                    const newImg = document.createElement('img');
                    newImg.src = ev.target.result;
                    newImg.className = 'task-img-preview';
                    newImg.id = `edit_preview_${taskId}`;
                    prev.replaceWith(newImg);
                }
            }
            document.getElementById(`edit_img_btn_label_${taskId}`).innerText = "âœ… ×ª××•× ×” ×”×•×—×œ×¤×”";
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function loadClasses() {
        if (!currentUser) return;
        // RULE 2: Keep query simple
        const q = query(getPublicCol("classes"), where("teacherId", "==", teacherKey));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('classesList');
            list.innerHTML = '';

            snap.forEach(cDoc => {
                const c = cDoc.data();
                const div = document.createElement('div');
                div.className = 'class-box';
                const now = new Date().toISOString().slice(0, 16);
                const tomorrow = new Date(Date.now() + 86400000).toISOString().slice(0, 16);
                
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <div>
                            <strong>ğŸ« ${c.name}</strong>
                            <span class="code-display" style="margin-right:10px;">${c.code}</span>
                        </div>
                    </div>
                    <div class="time-settings">
                        <div><label>×–××Ÿ ×”×ª×—×œ×”</label><input type="datetime-local" id="start_${c.code}" value="${now}"></div>
                        <div><label>×–××Ÿ ×¡×™×•×</label><input type="datetime-local" id="end_${c.code}" value="${tomorrow}"></div>
                    </div>
                    <div class="upload-area">
                        <input type="text" id="task_${c.code}" placeholder="××” ×”××©×™××”?">
                        <label class="file-label" id="label_${c.code}">ğŸ“· <input type="file" class="hidden" onchange="handleImg(event, '${c.code}')"></label>
                    </div>
                    <button onclick="addTask('${c.code}')">×¤×¨×¡× ××©×™××”</button>
                    <div id="tasks_${c.code}" style="margin-top:15px;"></div>
                `;
                list.appendChild(div);
                syncTasks(c.code);
            });
        }, (err) => handleError(err, "×˜×¢×™× ×ª ×›×™×ª×•×ª"));
    }

    window.addTask = async (code) => {
        if (!currentUser) return;
        const title = document.getElementById(`task_${code}`).value;
        const startTime = new Date(document.getElementById(`start_${code}`).value).getTime();
        const endTime = new Date(document.getElementById(`end_${code}`).value).getTime();
        const img = selectedImages[code] || null;

        if(!title && !img) return;

        try {
            await addDoc(getPublicCol("tasks"), {
                classCode: code,
                title: title || "××©×™××”",
                imageUrl: img,
                startTime,
                endTime,
                createdAt: Date.now()
            });
            document.getElementById(`task_${code}`).value = '';
            selectedImages[code] = null;
            if(document.getElementById(`label_${code}`)) document.getElementById(`label_${code}`).innerText = "ğŸ“·";
        } catch (e) {
            handleError(e, "×”×•×¡×¤×ª ××©×™××”");
        }
    };

    function syncTasks(code) {
        if (!currentUser) return;
        const q = query(getPublicCol("tasks"), where("classCode", "==", code));
        onSnapshot(q, (snap) => {
            const container = document.getElementById(`tasks_${code}`);
            if(!container) return;
            container.innerHTML = '';
            snap.forEach(tDoc => {
                const t = tDoc.data();
                const taskId = tDoc.id;
                const item = document.createElement('div');
                item.className = 'task-item';
                
                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div><strong>${t.title}</strong></div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-edit" onclick="toggleEdit('${taskId}')">âœï¸ ×¢×¨×•×š</button>
                            <button style="background:var(--danger); color:white; border:none; border-radius:4px; width:auto; padding:6px 10px; font-size:11px; cursor:pointer;" onclick="handleDeleteTask('${taskId}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div id="edit_ui_${taskId}" class="hidden edit-mode">
                        <label style="font-size:12px; font-weight:bold;">×›×•×ª×¨×ª:</label>
                        <input type="text" id="edit_title_${taskId}" value="${t.title}">
                        
                        <div style="margin-top:10px;">
                            <label style="font-size:12px; display:block; font-weight:bold;">×ª××•× ×”:</label>
                            ${t.imageUrl ? `<img src="${t.imageUrl}" id="edit_preview_${taskId}" class="task-img-preview" style="margin-bottom:8px;">` : `<div id="edit_preview_${taskId}" style="font-size:12px; color:#666; margin:5px 0;">××™×Ÿ ×ª××•× ×” ×›×¨×’×¢</div>`}
                            <label class="edit-img-label" id="edit_img_btn_label_${taskId}">
                                ğŸ“· ×”×—×œ×£ / ×”×•×¡×£ ×ª××•× ×”
                                <input type="file" class="hidden" onchange="handleEditImg(event, '${taskId}')">
                            </label>
                        </div>

                        <button onclick="saveEdit('${taskId}')" style="background:var(--accent); padding:8px; margin-top:12px;">×©××•×¨ ×©×™× ×•×™×™×</button>
                    </div>
                    ${!t.imageUrl ? '' : `<img src="${t.imageUrl}" class="task-img-preview" onclick="toggleEdit('${taskId}')">`}
                `;
                container.appendChild(item);
            });
        }, (err) => handleError(err, "×¡× ×›×¨×•×Ÿ ××©×™××•×ª"));
    }

    window.handleDeleteTask = async (taskId) => {
        if(!currentUser) return;
        if(confirm("×œ××—×•×§ ××ª ×”××©×™××” ×”×–×•?")) {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId));
            } catch (e) {
                handleError(e, "××—×™×§×ª ××©×™××”");
            }
        }
    };

    window.toggleEdit = (taskId) => {
        const el = document.getElementById(`edit_ui_${taskId}`);
        if(el) {
            el.classList.toggle('hidden');
            editingImages[taskId] = null;
        }
    };

    window.saveEdit = async (taskId) => {
        if(!currentUser) return;
        const title = document.getElementById(`edit_title_${taskId}`).value;
        const newImg = editingImages[taskId];
        
        const updates = { title };
        if (newImg) {
            updates.imageUrl = newImg;
        }

        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId), updates);
            toggleEdit(taskId);
            editingImages[taskId] = null;
        } catch (e) {
            handleError(e, "×¢×¨×™×›×ª ××©×™××”");
        }
    };
</script>
</body>
</html>
