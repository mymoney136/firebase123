<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, setDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ×”×’×“×¨×•×ª ×”×¤×¨×•×™×§×˜ ×©×œ×š
    const firebaseConfig = {
        apiKey: "AIzaSyDvnS8L9r2LMKcUD78Ix7bldVp9qzbYwtk",
        authDomain: "tast-7808e.firebaseapp.com",
        projectId: "tast-7808e",
        storageBucket: "tast-7808e.firebasestorage.app",
        messagingSenderId: "99024860024",
        appId: "1:99024860024:web:24ab70c10254a2014fce8d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- 1. ×™×¦×™×¨×ª ×©×“×•×ª ×œ××¢×¨×›×ª ×”×©×¢×•×ª ---
    const days = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™"];
    const scheduleContainer = document.getElementById('scheduleInputs');
    
    days.forEach((day, index) => {
        scheduleContainer.innerHTML += `
            <div class="day-box">
                <label>×™×•× ${day}</label>
                <textarea id="schedule-day-${index}" rows="4" placeholder="××ª××˜×™×§×” - 08:00\n×× ×’×œ×™×ª - 09:00"></textarea>
            </div>
        `;
    });

    // --- 2. ×¤×•× ×§×¦×™×” ×œ×©×œ×™×—×ª Push (×”×œ×•×’×™×§×”) ---
    async function sendPushToClass(code, taskTitle) {
        console.log("××›×™×Ÿ ×©×œ×™×—×ª ×”×ª×¨××” ×œ×›×™×ª×”:", code);
        
        // ××•×©×š ××ª ×¨×©×™××ª ×”-Tokens ×©×œ ×”×ª×œ××™×“×™×
        const tokenQuery = query(collection(db, "tokens"), where("classCode", "==", code));
        const tokenSnap = await getDocs(tokenQuery);
        
        let targetTokens = [];
        tokenSnap.forEach(d => {
            targetTokens.push(d.data().token);
        });

        if (targetTokens.length > 0) {
            console.log("× ××¦××• " + targetTokens.length + " ××›×©×™×¨×™× ×œ×©×œ×™×—×”.");
            // ×›××Ÿ ××ª×‘×¦×¢×ª ×”×¤× ×™×™×” ×œ-FCM
            // ×œ×¦×•×¨×š ×”×¤×¨×•×™×§×˜, ×× ×—× ×• ×× ×™×—×™× ×©×”×©×¨×ª ××•×¤×¢×œ ××• ×©×”×”×ª×¨××” ×¨×©×•××” ×‘-DB
            alert("×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×œ-" + targetTokens.length + " ×ª×œ××™×“×™×!");
        } else {
            console.warn("×œ× × ××¦××• ×ª×œ××™×“×™× ×¨×©×•××™× ×œ×›×™×ª×” ×–×• ×‘-Database.");
        }
    }

    // --- 3. ×”×•×¡×¤×ª ××©×™××” ×—×“×©×” ---
    window.createNewTask = async () => {
        const title = document.getElementById('taskTitle').value.trim();
        const code = document.getElementById('classCode').value.trim().toUpperCase();
        const endTime = document.getElementById('endTime').value;
        const imgInput = document.getElementById('taskImage');

        if (!title || !code || !endTime) {
            alert("×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª: ×›×•×ª×¨×ª, ×§×•×“ ×›×™×ª×” ×•×–××Ÿ ×”×’×©×”.");
            return;
        }

        console.log("××ª×—×™×œ ×©××™×¨×ª ××©×™××”...");

        // ×˜×™×¤×•×œ ×‘×ª××•× ×” (×”×•×¤×š ×œ-Base64)
        let base64Image = "";
        if (imgInput.files[0]) {
            const reader = new FileReader();
            base64Image = await new Promise((resolve) => {
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(imgInput.files[0]);
            });
        }

        try {
            const taskRef = await addDoc(collection(db, "tasks"), {
                title: title,
                classCode: code,
                endTime: new Date(endTime).getTime(),
                imageUrl: base64Image,
                createdAt: serverTimestamp(),
                worksheets: []
            });

            console.log("××©×™××” × ×©××¨×” ×‘-ID:", taskRef.id);
            
            // ×©×œ×™×—×ª ×”×ª×¨××”
            await sendPushToClass(code, title);

            // × ×™×§×•×™ ×˜×•×¤×¡
            document.getElementById('taskTitle').value = "";
            imgInput.value = "";
            alert("×”××©×™××” ×¢×œ×ª×” ×•×”×•×¤×¦×” ×œ×ª×œ××™×“×™×!");
            
        } catch (error) {
            console.error("×©×’×™××” ×‘×©××™×¨×”:", error);
            alert("×”×™×™×ª×” ×ª×§×œ×” ×‘×©××™×¨×ª ×”××©×™××”.");
        }
    };

    // --- 4. ×¢×“×›×•×Ÿ ××¢×¨×›×ª ×©×¢×•×ª ---
    window.updateClassSchedule = async () => {
        const code = document.getElementById('classCode').value.trim().toUpperCase();
        if (!code) {
            alert("×™×© ×œ×”×–×™×Ÿ ×§×•×“ ×›×™×ª×” ×›×“×™ ×œ×¢×“×›×Ÿ ××¢×¨×›×ª ×©×¢×•×ª.");
            return;
        }

        let fullSchedule = {};
        days.forEach((day, index) => {
            const content = document.getElementById(`schedule-day-${index}`).value;
            const lines = content.split('\n').filter(l => l.trim() !== "");
            
            fullSchedule[`day${index}`] = lines.map(line => {
                const parts = line.split('-');
                return {
                    subject: parts[0] ? parts[0].trim() : "×©×™×¢×•×¨",
                    time: parts[1] ? parts[1].trim() : "--:--"
                };
            });
        });

        try {
            await setDoc(doc(db, "classes", code), {
                code: code,
                schedule: fullSchedule,
                lastUpdated: serverTimestamp()
            }, { merge: true });

            alert("××¢×¨×›×ª ×”×©×¢×•×ª ×©×œ ×›×™×ª×” " + code + " ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!");
        } catch (e) {
            console.error(e);
            alert("×ª×§×œ×” ×‘×¢×“×›×•×Ÿ ×”××¢×¨×›×ª.");
        }
    };

    // --- 5. ×”×¦×’×ª ××©×™××•×ª ×§×™×™××•×ª ×‘×–××Ÿ ×××ª ---
    function syncTasks() {
        const tasksDiv = document.getElementById('adminTasksContainer');
        
        onSnapshot(collection(db, "tasks"), (snapshot) => {
            if (snapshot.empty) {
                tasksDiv.innerHTML = "<p>××™×Ÿ ××©×™××•×ª ×¤×¢×™×œ×•×ª ×›×¨×’×¢.</p>";
                return;
            }

            let html = "";
            snapshot.forEach((taskDoc) => {
                const task = taskDoc.data();
                const date = new Date(task.endTime).toLocaleString('he-IL');
                
                html += `
                    <div class="task-list-item">
                        <div>
                            <strong style="font-size:18px;">${task.title}</strong><br>
                            <small>×›×™×ª×”: ${task.classCode} | ×”×’×©×” ×¢×“: ${date}</small>
                        </div>
                        <button class="btn delete-btn" onclick="deleteTask('${taskDoc.id}')">××—×§ ××©×™××”</button>
                    </div>
                `;
            });
            tasksDiv.innerHTML = html;
        });
    }

    window.deleteTask = async (id) => {
        if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××©×™××”? ×”×™× ×ª×™×¢×œ× ×œ×›×œ ×”×ª×œ××™×“×™×.")) {
            await deleteDoc(doc(db, "tasks", id));
        }
    };

    // ×”×¤×¢×œ×” ×¨××©×•× ×™×ª
    syncTasks();
</script>
</body>
<body>
    <div class="container">
        <div class="admin-header">
            <h1>×œ×•×— ×‘×§×¨×” ×œ××•×¨×” - ×¨××œ×™ ××˜×•"×¡</h1>
            <p>× ×™×”×•×œ ××©×™××•×ª, ××¢×¨×›×ª ×©×¢×•×ª ×•×©×œ×™×—×ª ×”×ª×¨××•×ª Push ×‘×–××Ÿ ×××ª</p>
        </div>

        <div class="section-card">
            <h3>â• ×™×¦×™×¨×ª ××©×™××” ×•×”×¤×¦×ª ×”×ª×¨××”</h3>
            
            <div class="form-group">
                <label for="taskTitle">×©× ×”××©×™××” / × ×•×©× ×”×©×™×¢×•×¨</label>
                <input type="text" id="taskTitle" placeholder="×œ××©×œ: ×©×™×¢×•×¨×™ ×‘×™×ª ×‘×—×©×‘×•×Ÿ - ×¢××•×“ 42">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label for="classCode">×§×•×“ ×›×™×ª×” (×™×¢×“)</label>
                    <input type="text" id="classCode" placeholder="×œ××©×œ: A1">
                </div>
                <div class="form-group">
                    <label for="endTime">××•×¢×“ ×”×’×©×” ××—×¨×•×Ÿ (×“×“-×œ×™×™×Ÿ)</label>
                    <input type="datetime-local" id="endTime">
                </div>
            </div>

            <div class="form-group">
                <label for="taskImage">×¦×™×œ×•× ×”××©×™××” (××•×¤×¦×™×•× ×œ×™ - ×™×•×¤×™×¢ ××¦×œ ×”×ª×œ××™×“)</label>
                <input type="file" id="taskImage" accept="image/*" style="border: none; padding: 10px 0;">
            </div>

            <button class="btn btn-main" id="submitBtn" onclick="createNewTask()">
                <span>ğŸš€</span> ×©××•×¨ ××©×™××” ×•×©×œ×— ×”×ª×¨××” ×œ×›×œ ×”×ª×œ××™×“×™×
            </button>
        </div>

        <div class="section-card">
            <h3>ğŸ“… ×¢×“×›×•×Ÿ ××¢×¨×›×ª ×©×¢×•×ª ×©×‘×•×¢×™×ª</h3>
            <p style="font-size: 14px; opacity: 0.7; margin-bottom: 15px;">×”×–×Ÿ ××ª ×”××§×¦×•×¢×•×ª ×•×”×©×¢×•×ª ×¢×‘×•×¨ ×”×›×™×ª×” ×©×”×–× ×ª ×œ××¢×œ×”. ×¤×•×¨××˜: "××§×¦×•×¢ - ×©×¢×”"</p>
            
            <div class="schedule-grid" id="scheduleInputs">
                </div>
            
            <button class="btn btn-main" style="background: var(--success); margin-top: 25px;" onclick="updateClassSchedule()">
                ğŸ’¾ ×¢×“×›×Ÿ ××¢×¨×›×ª ×©×¢×•×ª ×œ×›×™×ª×” ×–×•
            </button>
        </div>

        <div class="section-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">ğŸ“ ××©×™××•×ª ×¤×¢×™×œ×•×ª ×‘××¢×¨×›×ª</h3>
                <span id="taskCount" style="background: var(--primary); padding: 2px 10px; border-radius: 20px; font-size: 12px; font-weight: bold;">0 ××©×™××•×ª</span>
            </div>
            
            <div id="adminTasksContainer">
                <div style="text-align: center; padding: 20px; opacity: 0.5;">
                    ×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×©×¨×ª...
                </div>
            </div>
        </div>
    </div>
    <script type="module">
    // ×™×™×‘×•× ×¡×¤×¨×™×•×ª Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, setDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ×§×•× ×¤×™×’×•×¨×¦×™×” ××œ××”
    const firebaseConfig = {
        apiKey: "AIzaSyDvnS8L9r2LMKcUD78Ix7bldVp9qzbYwtk",
        authDomain: "tast-7808e.firebaseapp.com",
        projectId: "tast-7808e",
        storageBucket: "tast-7808e.firebasestorage.app",
        messagingSenderId: "99024860024",
        appId: "1:99024860024:web:24ab70c10254a2014fce8d"
    };

    // ××ª×—×•×œ
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- 1. ×‘× ×™×™×ª ×××©×§ ×¢×¨×™×›×ª ××¢×¨×›×ª ×”×©×¢×•×ª ---
    const days = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™"];
    const scheduleInputs = document.getElementById('scheduleInputs');
    
    days.forEach((day, index) => {
        scheduleInputs.innerHTML += `
            <div class="day-box">
                <label style="color:var(--primary); font-weight:800;">×™×•× ${day}</label>
                <textarea id="schedule-day-${index}" rows="5" placeholder="××ª××˜×™×§×” - 08:15\n×× ×’×œ×™×ª - 09:10\n××“×¢×™× - 10:30"></textarea>
            </div>
        `;
    });

    // --- 2. ×¤×•× ×§×¦×™×™×ª ×©×œ×™×—×ª ×”×ª×¨××ª Push (×¡×™××•×œ×¦×™×” ×•× ×™×”×•×œ Tokens) ---
    async function sendPushNotification(code, taskTitle) {
        console.log("××ª×—×™×œ ×ª×”×œ×™×š ×©×œ×™×—×ª ×”×ª×¨××” ×œ×›×™×ª×”:", code);
        
        try {
            // ×©×œ×™×¤×ª ×”-Tokens ×©×œ ×›×œ ×”×ª×œ××™×“×™× ×‘×›×™×ª×” ×”××™×•×¢×“×ª
            const q = query(collection(db, "tokens"), where("classCode", "==", code));
            const querySnapshot = await getDocs(q);
            
            let tokens = [];
            querySnapshot.forEach((doc) => {
                tokens.push(doc.data().token);
            });

            if (tokens.length === 0) {
                console.warn("×œ× × ××¦××• ×ª×œ××™×“×™× ×¨×©×•××™× ×œ×”×ª×¨××•×ª ×‘×›×™×ª×” " + code);
                alert("×”××©×™××” × ×©××¨×”, ××š ×œ× × ××¦××• ×ª×œ××™×“×™× ×¨×©×•××™× ×œ×”×ª×¨××•×ª (Push).");
                return;
            }

            console.log("×©×•×œ×— ×”×ª×¨××” ×œ-" + tokens.length + " ××›×©×™×¨×™×...");
            // ×›××Ÿ ×ª×‘×•× ×”×¤× ×™×™×” ×œ-Cloud Function ××• FCM API
            // ×œ×¦×•×¨×š ×”×“×’××”, ×”××•×¨×” ××§×‘×œ ××©×•×‘ ×¢×œ ×›××•×ª ×”××›×©×™×¨×™× ×©×™×§×‘×œ×• ××ª ×”×”×•×“×¢×”
            alert("×”×”×ª×¨××” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×œ-" + tokens.length + " ×ª×œ××™×“×™×!");

        } catch (error) {
            console.error("×©×’×™××” ×‘×©×œ×™×—×ª ×”×ª×¨××”:", error);
        }
    }

    // --- 3. ×™×¦×™×¨×ª ××©×™××” ×—×“×©×” ---
    window.createNewTask = async () => {
        const title = document.getElementById('taskTitle').value.trim();
        const code = document.getElementById('classCode').value.trim().toUpperCase();
        const endTime = document.getElementById('endTime').value;
        const fileInput = document.getElementById('taskImage');
        const submitBtn = document.getElementById('submitBtn');

        if (!title || !code || !endTime) {
            alert("×—×•×‘×” ×œ××œ× ×›×•×ª×¨×ª, ×§×•×“ ×›×™×ª×” ×•×–××Ÿ ×”×’×©×”.");
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerText = "×©×•××¨ ×•×©×•×œ×— ×”×ª×¨××•×ª...";

        let base64Image = "";
        
        // ×”××¨×ª ×ª××•× ×” ×œ-Base64 ×‘××™×“×” ×•×”×•×¢×œ×ª×”
        if (fileInput.files[0]) {
            const reader = new FileReader();
            base64Image = await new Promise((resolve) => {
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(fileInput.files[0]);
            });
        }

        try {
            // ×©××™×¨×ª ×”××©×™××” ×‘-Firestore
            const docRef = await addDoc(collection(db, "tasks"), {
                title: title,
                classCode: code,
                endTime: new Date(endTime).getTime(),
                imageUrl: base64Image,
                createdAt: serverTimestamp(),
                worksheets: [] // ××¢×¨×š ×¨×™×§ ×œ×”×’×©×•×ª ×¢×ª×™×“×™×•×ª
            });

            console.log("×”××©×™××” × ×©××¨×” ×‘-ID:", docRef.id);

            // ×©×œ×™×—×ª ×”×ª×¨××ª Push ×œ×ª×œ××™×“×™×
            await sendPushNotification(code, title);

            // ××™×¤×•×¡ ×˜×•×¤×¡
            document.getElementById('taskTitle').value = "";
            fileInput.value = "";
            submitBtn.disabled = false;
            submitBtn.innerHTML = "<span>ğŸš€</span> ×©××•×¨ ××©×™××” ×•×©×œ×— ×”×ª×¨××” ×œ×›×œ ×”×ª×œ××™×“×™×";
            
        } catch (e) {
            console.error("×©×’×™××” ×‘×ª×”×œ×™×š ×”×©××™×¨×”:", e);
            alert("×ª×§×œ×” ×‘×©××™×¨×”. ×‘×“×•×§ ×§×•× ×¡×•×œ.");
            submitBtn.disabled = false;
        }
    };

    // --- 4. ×¢×“×›×•×Ÿ ××¢×¨×›×ª ×©×¢×•×ª ---
    window.updateClassSchedule = async () => {
        const code = document.getElementById('classCode').value.trim().toUpperCase();
        if (!code) {
            alert("×× × ×”×–×Ÿ ×§×•×“ ×›×™×ª×” ×‘×©×“×” ×œ××¢×œ×” ×›×“×™ ×œ×“×¢×ª ×œ××™×–×• ×›×™×ª×” ×œ×¢×“×›×Ÿ ××ª ×”×œ×•×–.");
            return;
        }

        let scheduleObj = {};
        days.forEach((day, index) => {
            const rawText = document.getElementById(`schedule-day-${index}`).value;
            const lines = rawText.split('\n').filter(line => line.trim() !== "");
            
            scheduleObj[`day${index}`] = lines.map(line => {
                const parts = line.split('-');
                return {
                    subject: parts[0] ? parts[0].trim() : "×©×™×¢×•×¨",
                    time: parts[1] ? parts[1].trim() : ""
                };
            });
        });

        try {
            await setDoc(doc(db, "classes", code), {
                code: code,
                schedule: scheduleObj,
                lastUpdated: serverTimestamp()
            }, { merge: true });

            alert("××¢×¨×›×ª ×”×©×¢×•×ª ×©×œ ×›×™×ª×” " + code + " ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!");
        } catch (err) {
            console.error("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×œ×•×–:", err);
            alert("×ª×§×œ×” ×‘×¢×“×›×•×Ÿ ×”×œ×•×–.");
        }
    };

    // --- 5. × ×™×”×•×œ ××©×™××•×ª ×§×™×™××•×ª ×‘×–××Ÿ ×××ª ---
    function initTasksManagement() {
        const container = document.getElementById('adminTasksContainer');
        const countSpan = document.getElementById('taskCount');

        // ×”××–× ×” ×—×™×” ×œ×›×œ ×”××©×™××•×ª
        onSnapshot(collection(db, "tasks"), (snapshot) => {
            countSpan.innerText = snapshot.size + " ××©×™××•×ª";
            
            if (snapshot.empty) {
                container.innerHTML = '<div style="text-align:center; opacity:0.5;">××™×Ÿ ××©×™××•×ª ×¤×¢×™×œ×•×ª ×‘××¢×¨×›×ª.</div>';
                return;
            }

            let html = "";
            snapshot.forEach((taskDoc) => {
                const data = taskDoc.data();
                const date = new Date(data.endTime).toLocaleString('he-IL', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                });

                html += `
                    <div class="task-list-item">
                        <div style="flex:1;">
                            <div style="font-weight:800; font-size:18px;">${data.title}</div>
                            <div style="font-size:13px; opacity:0.7;">×›×™×ª×”: ${data.classCode} | ×”×’×©×” ×¢×“: ${date}</div>
                        </div>
                        <button class="btn delete-btn" onclick="deleteTask('${taskDoc.id}')">××—×§ ğŸ—‘ï¸</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        });
    }

    // ×¤×•× ×§×¦×™×™×ª ××—×™×§×”
    window.deleteTask = async (id) => {
        if (confirm("×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××©×™××”? ×”×¤×¢×•×œ×” ×ª××—×•×§ ××•×ª×” ×’× ××¦×œ ×”×ª×œ××™×“×™×.")) {
            try {
                await deleteDoc(doc(db, "tasks", id));
            } catch (e) {
                alert("×ª×§×œ×” ×‘××—×™×§×”.");
            }
        }
    };

    // ×”×¤×¢×œ×” ×‘×˜×¢×™× ×ª ×”×“×£
    initTasksManagement();

</script>
</body>
</html>
</html>
